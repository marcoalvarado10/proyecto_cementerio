{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - Mi Sitio Web</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=1.0">
</head>

<body>

    <!-- Incluir header -->
    {% include "includes/header.html" %}

    <!-- Banner estático -->
    <div class="static-banner">
        <img class="d-block w-100 banner-image" src="{% static 'img/banner2.png' %}" alt="Banner" style="height: 470px; object-fit: cover;">
        <div class="overlay-content">
            <h1>¿Buscas Algún Familiar o Conocido?</h1>
            
            <!-- Formulario de Búsqueda -->
            <form id="searchForm" class="search-form" onsubmit="return false;">

                <div class="input-group">

                    <input id="nombre" type="text" name="nombre" placeholder="Nombre" class="form-control">
                    <input id="apellido_p" type="text" name="apellido_p" placeholder="Apellido Paterno" class="form-control">
                    <input id="apellido_m" type="text" name="apellido_m" placeholder="Apellido Materno" class="form-control">
                    
                    <!-- Separador -->
                    <span class="input-group-text separator-icon"><i class="fas fa-exchange-alt"></i></span>
                    
                    <input id="rut" type="text" name="rut" placeholder="RUT" class="form-control">
                    <button type="submit" class="btn btn-search"><i class="fas fa-search"></i></button>
                </div>
            </form>

<script>
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const nombre = document.getElementById('nombre').value.trim();
    const apellidoP = document.getElementById('apellido_p').value.trim();
    const apellidoM = document.getElementById('apellido_m').value.trim();
    const rut = document.getElementById('rut').value.trim();
    
    // Si hay RUT, buscar solo por RUT
    if (rut) {
        const params = new URLSearchParams({ rut: rut });
        realizarBusqueda(params);
    } else {
// Validación: nombre requiere AL MENOS UN apellido
if (nombre && !apellidoP && !apellidoM) {
    alert('⚠️ Para buscar por nombre debes ingresar al menos un apellido');
    return;
}
        
        
        // Debe haber al menos un criterio
        if (!nombre && !apellidoP && !apellidoM) {
            alert('⚠️ Por favor ingresa al menos un criterio de búsqueda');
            return;
        }

        
        
        // Construir parámetros
        const params = new URLSearchParams();
        if (nombre) params.append('nombre', nombre);
        if (apellidoP) params.append('apellido_p', apellidoP);
        if (apellidoM) params.append('apellido_m', apellidoM);
        
        realizarBusqueda(params);
    }
});

function realizarBusqueda(params) {
    fetch(`/buscar-fallecido/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('searchResults');
            
            if (data.error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> ${data.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                return;
            }
            
if (data.resultados.length === 0) {
    resultsDiv.innerHTML = `
        <div class="card border-warning mt-3 shadow">
            <div class="card-body bg-warning bg-opacity-10">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-dark">
                        <i class="fas fa-info-circle text-warning fs-4"></i> 
                        <strong class="fs-5">No se encontraron resultados</strong>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="limpiarResultados()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
} else {
    let html = `
        <div class="card border-success mt-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-circle"></i> ${data.resultados.length} resultado(s) encontrado(s)</span>
                <button class="btn btn-light btn-sm" onclick="limpiarResultados()">
                    <i class="fas fa-times"></i> Cerrar Resultados
                </button>
            </div>
            <div class="card-body p-3">
                <div class="row g-3">
    `;
    
    data.resultados.forEach(fallecido => {
        const nombreCompleto = `${fallecido.nombre} ${fallecido.segundo_nombre} ${fallecido.apellido_p} ${fallecido.apellido_m}`.replace(/\s+/g, ' ').trim();
        const fotoUrl = fallecido.foto_url || '';
        
        html += `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        ${fotoUrl ? 
                            `<img src="${fotoUrl}" alt="Foto" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #dee2e6;">` :
                            `<i class="fas fa-user-circle fa-5x text-muted mb-3"></i>`
                        }
                        <h5 class="card-title">${nombreCompleto}</h5>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-id-card"></i> ${fallecido.rut}
                        </p>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-calendar"></i> ${fallecido.fechafallecimiento}
                        </p>
                        <p class="text-muted small mb-3">
                            <i class="fas fa-map-marker-alt"></i> ${fallecido.ubicacion}
                        </p>
                        ${fallecido.historia ? 
                            `<div class="alert alert-light small text-start" style="max-height: 100px; overflow-y: auto;">
                                <i class="fas fa-book text-primary"></i>
                                <em>${fallecido.historia}</em>
                            </div>` : 
                            ''
                        }
                        <a href="/detalle/${fallecido.id}/" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
        </div>
    `;
    resultsDiv.innerHTML = html;
    
                
                // Scroll suave a resultados
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('searchResults').innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> Error al realizar la búsqueda
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        });
}

function limpiarResultados() {
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchForm').reset();
}
</script>

<!-- Resultados de búsqueda -->
<div id="searchResults" class="mt-4"></div>
        </div>
    </div>

    <!-- Sección de información adicional -->
    <div class="info-section">
        <img src="{% static 'img/imagenabajo.webp' %}" alt="Imagen descriptiva" class="info-image">
        <div class="info-text">
            <h2>¿Cuál es el proceso para despedir a tu ser querido?</h2>
            <p>Si deseas ayuda inmediata o necesitas activar alguno de tus productos, te ofrecemos nuestro acompañamiento integral en donde uno de nuestros asesores te guiarán en cada paso de este proceso.</p>
            <ol>
                <li>Obtener certificado médico de defunción.</li>
                <li>Decidir lugar de velación y tipo de despedida.</li>
                <li>Adquirir servicio funerario y cremación / sepultación.</li>
                <li>Velación.</li>
                <li>Ceremonia de sepultación o cremación.</li>
            </ol>
            <button onclick="window.open('https://wa.me/56978202721?text=Hola,%20necesito%20información%20sobre%20sus%20servicios', '_blank');" class="contact-button">
                <i class="fab fa-whatsapp"></i> Quiero contactarme
            </button>
        </div>
    </div>

    <!-- Incluir footer -->
    {% include "includes/footer.html" %}

    <!-- Bootstrap JS (solo uno, corregido) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

</body>
</html>
