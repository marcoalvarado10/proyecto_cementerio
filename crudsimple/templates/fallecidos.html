{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administraci√≥n</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome para los √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    {% include "includes/logout.html" %}

    <div class="container">
        <br>
        <h1 class="text-center mb-4" style="/*padding-left: 30%;*/">ùìõùì≤ùìºùìΩùì™ ùìïùì™ùìµùìµùìÆùì¨ùì≤ùì≠ùì∏ùìº</h1>

        <!-- =======================================================
             FILTROS
             ======================================================= -->
        <form method="get" action="{% url 'listadoFallecidos' %}" class="mb-4">
            <div class="row g-3">
                <!-- Filtros de texto -->
                <div class="col-md-3">
                    <input type="text" name="rut" class="form-control campo-input" placeholder="Rut"
                        value="{{ request.GET.rut|default_if_none:'' }}">
                </div>
                <div class="col-md-3">
                    <input type="text" name="nombre" class="form-control campo-input" placeholder="Nombre"
                        value="{{ request.GET.nombre|default_if_none:'' }}">
                </div>
                <div class="col-md-3">
                    <input type="text" name="apellido_p" class="form-control campo-input"
                        value="{{ request.GET.apellido_p|default_if_none:'' }}" placeholder="Apellido Paterno">
                </div>
                <div class="col-md-3">
                    <input type="text" name="apellido_m" class="form-control campo-input"
                        value="{{ request.GET.apellido_m|default_if_none:'' }}" placeholder="Apellido Materno">
                </div>

                <!-- Filtros de fecha -->
                <div class="col-md-3">
                    <input type="date" name="fecha_inicio" class="form-control campo-input"
                        value="{{ request.GET.fecha_inicio|default_if_none:'' }}">
                </div>
                <div class="col-md-3">
                    <input type="date" name="fecha_fin" class="form-control campo-input"
                        value="{{ request.GET.fecha_fin|default_if_none:'' }}">
                </div>

                <!-- Filtro de Ubicaci√≥n -->
                <div class="col-md-3">
                    <select name="ubicacion" class="form-control campo-input">
                        <option value="">Seleccione una ubicaci√≥n</option>
                        {% if request.GET.ubicacion == "sotano" %}
                        <option value="sotano" selected>S√≥tano</option>
                        {% else %}
                        <option value="sotano">S√≥tano</option>
                        {% endif %}

                        {% if request.GET.ubicacion == "bloque_1" %}
                        <option value="bloque_1" selected>Bloque 1</option>
                        {% else %}
                        <option value="bloque_1">Bloque 1</option>
                        {% endif %}

                        {% if request.GET.ubicacion == "bloque_2" %}
                        <option value="bloque_2" selected>Bloque 2</option>
                        {% else %}
                        <option value="bloque_2">Bloque 2</option>
                        {% endif %}

                        {% if request.GET.ubicacion == "miramar" %}
                        <option value="miramar" selected>Miramar</option>
                        {% else %}
                        <option value="miramar">Miramar</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Bot√≥n de filtro -->
                <div class="col-md-3 d-grid">
                    <div class="btn-group" role="group" style="width: 100%;">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Filtrar</button>
                        <a href="{% url 'listadoFallecidos' %}" class="btn btn-secondary"><i class="fas fa-times"></i>
                            Limpiar</a>
                    </div>
                </div>
            </div>
        </form>

        <!-- =======================================================
             MENSAJES DE ALERTA
             ======================================================= -->
        {% if messages %}
        <div id="message-container">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags|cut:'safe' }}{% else %}alert-info{% endif %} alert-dismissible fade show"
                role="alert">
                {% if 'safe' in message.tags %}
                {{ message|safe }}
                {% else %}
                {{ message }}
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- =======================================================
             FORMULARIO AGREGAR FALLECIDO
             enctype multipart para foto (si subes)
             ======================================================= -->
        <!-- Formulario Colapsable para agregar fallecido -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white" style="cursor: pointer;" data-bs-toggle="collapse"
                data-bs-target="#formAgregar">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle"></i> Agregar Fallecido
                    <small class="float-end"><i class="fas fa-chevron-down"></i></small>
                </h4>
            </div>
            <div class="collapse" id="formAgregar">
                <div class="card-body">
                    <form method="post" action="{% url 'agregarFallecido' %}" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- SECCI√ìN 1: DATOS PERSONALES -->
                        <div class="border-start border-primary border-4 ps-3 mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-user"></i> Datos del Fallecido</h5>

                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <label for="rut" class="form-label">RUT *</label>
                                    <input type="text" class="form-control campo-input" id="rut" name="rut"
                                        placeholder="12.345.678-9" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="nombre" class="form-label">Primer Nombre *</label>
                                    <input type="text" class="form-control campo-input" id="nombre" name="nombre"
                                        placeholder="Primer Nombre" pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+"
                                        oninput="this.value = this.value.toUpperCase()" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="segundo_nombre" class="form-label">Segundo Nombre</label>
                                    <input type="text" class="form-control campo-input" id="segundo_nombre"
                                        name="segundo_nombre" placeholder="Opcional" pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+"
                                        oninput="this.value = this.value.toUpperCase()">
                                </div>
                                <div class="col-md-3">
                                    <label for="apellido_p" class="form-label">Apellido Paterno *</label>
                                    <input type="text" class="form-control campo-input" id="apellido_p"
                                        name="apellido_p" placeholder="Apellido Paterno"
                                        pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+"
                                        oninput="this.value = this.value.toUpperCase()" required>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <label for="apellido_m" class="form-label">Apellido Materno *</label>
                                    <input type="text" class="form-control campo-input" id="apellido_m"
                                        name="apellido_m" placeholder="Apellido Materno"
                                        pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+"
                                        oninput="this.value = this.value.toUpperCase()" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="fechafallecimiento" class="form-label">Fecha Fallecimiento *</label>
                                    <input type="date" class="form-control campo-input" id="fechafallecimiento"
                                        name="fechafallecimiento" max="{{ today }}" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="ubicacion" class="form-label">Ubicaci√≥n *</label>
                                    <select class="form-control campo-input" id="ubicacion" name="ubicacion" required>
                                        <option value="">Seleccione</option>
                                        <option value="sotano">S√≥tano</option>
                                        <option value="bloque_1">Bloque 1</option>
                                        <option value="bloque_2">Bloque 2</option>
                                        <option value="miramar">Miramar</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="foto" class="form-label">Foto</label>
                                    <input type="file" class="form-control campo-input" id="foto" name="foto"
                                        accept="image/*">
                                </div>
                            </div>
                        </div>

                        <!-- SECCI√ìN 2: COORDENADAS -->
                        <div class="border-start border-info border-4 ps-3 mb-4">
                            <h5 class="text-info mb-3"><i class="fas fa-map-marked-alt"></i> Ubicaci√≥n GPS</h5>

                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="latitud" class="form-label">Latitud</label>
                                    <input type="text" class="form-control campo-input" id="latitud" name="latitud"
                                        placeholder="-33.0472">
                                    <small class="text-muted">Ejemplo: -33.0472</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="longitud" class="form-label">Longitud</label>
                                    <input type="text" class="form-control campo-input" id="longitud" name="longitud"
                                        placeholder="-71.6127">
                                    <small class="text-muted">Ejemplo: -71.6127</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="maps" class="form-label">Link Google Maps</label>
                                    <input type="url" class="form-control campo-input" id="maps" name="maps"
                                        placeholder="https://maps.google.com/...">
                                </div>
                            </div>
                        </div>

                        <!-- SECCI√ìN 3: HISTORIA -->
                        <div class="border-start border-warning border-4 ps-3 mb-4">
                            <h5 class="text-warning mb-3"><i class="fas fa-book"></i> Historia / Rese√±a</h5>

                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <textarea class="form-control campo-input" id="historia" name="historia" rows="4"
                                        placeholder="Escribe una breve historia, an√©cdotas o momentos memorables del fallecido..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- SECCI√ìN 4: FAMILIAR RESPONSABLE -->
                        <div class="border-start border-success border-4 ps-3 mb-4">
                            <h5 class="text-success mb-3"><i class="fas fa-users"></i> Familiar Responsable</h5>

                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="nombre_familiar" class="form-label">Nombre Completo *</label>
                                    <input type="text" class="form-control campo-input" id="nombre_familiar"
                                        name="nombre_familiar" placeholder="Nombre del familiar" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="email_familiar" class="form-label">Email</label>
                                    <input type="email" class="form-control campo-input" id="email_familiar"
                                        name="email_familiar" placeholder="correo@ejemplo.com">
                                </div>
                                <div class="col-md-3">
                                    <label for="telefono_familiar" class="form-label">Tel√©fono *</label>
                                    <input type="tel" class="form-control campo-input" id="telefono_familiar"
                                        name="telefono_familiar" placeholder="+56 9 1234 5678" required>
                                </div>
                                <div class="col-md-2">
                                    <label for="parentesco" class="form-label">Parentesco *</label>
                                    <select class="form-control campo-input" id="parentesco" name="parentesco" required>
                                        <option value="">Seleccione</option>
                                        <option value="hijo">Hijo/a</option>
                                        <option value="esposo">Esposo/a</option>
                                        <option value="padre">Padre/Madre</option>
                                        <option value="hermano">Hermano/a</option>
                                        <option value="nieto">Nieto/a</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES -->
                        <div class="row">
                            <div class="col-md-12 d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="fas fa-eraser"></i> Limpiar
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Guardar Fallecido
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- =======================================================
             TABLA DE FALLECIDOS (CORREGIDA Y SIN ERRORES DE BLOQUES)
             ======================================================= -->
        {% if fallecidos %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>RUT</th>
                        <th>Foto</th>
                        <th>Nombre</th>
                        <th>Apellido P</th>
                        <th>Apellido M</th>
                        <th>Fecha Fallecimiento</th>
                        <th>Ubicaci√≥n</th>
                        <th>Maps</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fallecido in fallecidos %}
                    <tr>
                        <td>{{ fallecido.rut }}</td>
                        <td class="text-center">
                            {% if fallecido.foto %}
                            <img src="{{ fallecido.foto.url }}" alt="Foto"
                                style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
                            {% else %}
                            <i class="fas fa-user-circle fa-3x text-muted"></i>
                            {% endif %}
                        </td>
                        <td>
                            {{ fallecido.nombre }}
                            {% if fallecido.segundo_nombre and fallecido.segundo_nombre != "None" %}
                            {{ fallecido.segundo_nombre }}
                            {% endif %}
                        </td>
                        <td>{{ fallecido.apellido_p }}</td>
                        <td>{{ fallecido.apellido_m }}</td>
                        <td>{{ fallecido.fechafallecimiento|date:"d-m-Y" }}</td>
                        <td>{{ fallecido.ubicacion }}</td>
                        <td>
                            {% if fallecido.latitud and fallecido.longitud %}
                            <a href="{% url 'mapa_tumba' fallecido.id %}" class="btn btn-sm btn-info" title="Ver Mapa">
                                <i class="fas fa-map-marked-alt"></i>
                            </a>
                            {% elif fallecido.maps %}
                            <a href="{{ fallecido.maps }}" target="_blank" class="btn btn-sm btn-info"
                                title="Google Maps">
                                <i class="fas fa-map-marker-alt"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'detalle_fallecido' fallecido.id %}" class="btn btn-info btn-sm"
                                title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal"
                                data-id="{{ fallecido.id }}" data-rut="{{ fallecido.rut }}"
                                data-nombre="{{ fallecido.nombre }}"
                                data-segundo_nombre="{{ fallecido.segundo_nombre }}"
                                data-apellido_p="{{ fallecido.apellido_p }}"
                                data-apellido_m="{{ fallecido.apellido_m }}"
                                data-fechafallecimiento="{{ fallecido.fechafallecimiento|date:'Y-m-d' }}"
                                data-ubicacion="{{ fallecido.ubicacion }}" data-maps="{{ fallecido.maps }}"
                                data-latitud="{{ fallecido.latitud }}" data-longitud="{{ fallecido.longitud }}"
                                data-nombre_familiar="{{ fallecido.nombre_familiar }}"
                                data-email_familiar="{{ fallecido.email_familiar }}"
                                data-telefono_familiar="{{ fallecido.telefono_familiar }}"
                                data-parentesco="{{ fallecido.parentesco }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{% url 'eliminarFallecido' fallecido.id %}" class="btn btn-danger btn-sm"
                                onclick="return confirm('¬øEst√° seguro de eliminar este registro?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                        {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i> <strong>No se encontraron resultados en el sistema</strong>
        </div>
        {% endif %}

    </div> <!-- /container -->

    <!-- =======================================================
         MODAL DE EDICI√ìN (CORREGIDO)
         - El action contiene placeholder 0 que se reemplaza con JS
         ======================================================= -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="editModalLabel"><i class="fas fa-edit"></i> Editar Fallecido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- mantenemos placeholder 0 en la URL para reemplazarlo con JS al abrir modal -->
                <form method="post" action="{% url 'actualizarFallecido' 0 %}" id="editForm"
                    enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="edit-id">

                    <div class="modal-body">
                        <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Datos del Fallecido</h6>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-rut" class="form-label">RUT</label>
                                <input type="text" class="form-control campo-input" id="edit-rut" name="rut" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-nombre" class="form-label">Primer Nombre</label>
                                <input type="text" class="form-control campo-input" id="edit-nombre" name="nombre"
                                    required>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-segundo_nombre" class="form-label">Segundo Nombre</label>
                                <input type="text" class="form-control campo-input" id="edit-segundo_nombre"
                                    name="segundo_nombre">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-apellido_p" class="form-label">Apellido Paterno</label>
                                <input type="text" class="form-control campo-input" id="edit-apellido_p"
                                    name="apellido_p" required>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-apellido_m" class="form-label">Apellido Materno</label>
                                <input type="text" class="form-control campo-input" id="edit-apellido_m"
                                    name="apellido_m" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-fechafallecimiento" class="form-label">Fecha Fallecimiento</label>
                                <input type="date" class="form-control campo-input" id="edit-fechafallecimiento"
                                    name="fechafallecimiento" required>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-ubicacion" class="form-label">Ubicaci√≥n</label>
                                <select class="form-control campo-input" id="edit-ubicacion" name="ubicacion" required>
                                    <option value="">Seleccione ubicaci√≥n</option>
                                    <option value="sotano">S√≥tano</option>
                                    <option value="bloque_1">Bloque 1</option>
                                    <option value="bloque_2">Bloque 2</option>
                                    <option value="miramar">Miramar</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-maps" class="form-label">Google Maps (URL)</label>
                                <input type="url" class="form-control campo-input" id="edit-maps" name="maps"
                                    placeholder="https://maps.google.com/...">
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-latitud" class="form-label">Latitud</label>
                                <input type="text" class="form-control campo-input" id="edit-latitud" name="latitud"
                                    placeholder="-33.0472">
                                <small class="text-muted">Ejemplo: -33.0472</small>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-longitud" class="form-label">Longitud</label>
                                <input type="text" class="form-control campo-input" id="edit-longitud" name="longitud"
                                    placeholder="-71.6127">
                                <small class="text-muted">Ejemplo: -71.6127</small>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-success mb-3"><i class="fas fa-users"></i> Datos del Familiar</h6>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-nombre_familiar" class="form-label">Nombre del Familiar</label>
                                <input type="text" class="form-control campo-input" id="edit-nombre_familiar"
                                    name="nombre_familiar">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-email_familiar" class="form-label">Email</label>
                                <input type="email" class="form-control campo-input" id="edit-email_familiar"
                                    name="email_familiar">
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="edit-telefono_familiar" class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control campo-input" id="edit-telefono_familiar"
                                    name="telefono_familiar">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-parentesco" class="form-label">Parentesco</label>
                                <select class="form-control campo-input" id="edit-parentesco" name="parentesco">
                                    <option value="">Seleccione</option>
                                    <option value="hijo">Hijo/a</option>
                                    <option value="esposo">Esposo/a</option>
                                    <option value="padre">Padre/Madre</option>
                                    <option value="hermano">Hermano/a</option>
                                    <option value="nieto">Nieto/a</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>

                    </div> <!-- modal-body -->

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i
                                class="fas fa-times"></i> Cerrar</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar
                            Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =======================================================
         SCRIPTS
         ======================================================= -->
    <script>
        // Rellenar modal al abrir
        document.addEventListener('DOMContentLoaded', function () {
            const editModal = document.getElementById('editModal');
            if (!editModal) return;

            editModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (!button) return;

                const fallecidoId = button.getAttribute('data-id') || '';
                document.getElementById('edit-id').value = fallecidoId;

                // Reemplaza placeholder 0 en el action por el id (si tu URL lo requiere)
                const editForm = document.getElementById('editForm');
                if (editForm && editForm.action) {
                    editForm.action = `{% url 'actualizarFallecido' 0 %}`.replace('0', fallecidoId);
                }

                const setValue = (id, attr) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.value = button.getAttribute(attr) || '';
                };

                setValue('edit-rut', 'data-rut');
                setValue('edit-nombre', 'data-nombre');
                setValue('edit-segundo_nombre', 'data-segundo_nombre');
                setValue('edit-apellido_p', 'data-apellido_p');
                setValue('edit-apellido_m', 'data-apellido_m');
                setValue('edit-fechafallecimiento', 'data-fechafallecimiento');
                setValue('edit-ubicacion', 'data-ubicacion');
                setValue('edit-maps', 'data-maps');
                setValue('edit-latitud', 'data-latitud');
                setValue('edit-longitud', 'data-longitud');
                setValue('edit-nombre_familiar', 'data-nombre_familiar');
                setValue('edit-email_familiar', 'data-email_familiar');
                setValue('edit-telefono_familiar', 'data-telefono_familiar');
                setValue('edit-parentesco', 'data-parentesco');
            });
        });

        // Auto-ocultar mensajes despu√©s de 5 segundos
        setTimeout(() => {
            const messageContainer = document.getElementById('message-container');
            if (messageContainer) {
                messageContainer.style.transition = "opacity 1s ease";
                messageContainer.style.opacity = "0";
                setTimeout(() => messageContainer.remove(), 1000);
            }
        }, 5000);
    </script>

    <!-- Script para formatear y validar RUT chileno -->
    <script>
        function formatearRUT(rut) {
            rut = rut.replace(/[^\dkK]/g, '');
            if (rut.length === 0) return '';
            let cuerpo = rut.slice(0, -1);
            let dv = rut.slice(-1).toUpperCase();
            cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            if (cuerpo.length > 0) {
                return cuerpo + '-' + dv;
            }
            return dv;
        }

        function validarRUT(rut) {
            rut = rut.replace(/[^\dkK]/g, '');
            if (rut.length < 2) return false;
            let cuerpo = rut.slice(0, -1);
            let dv = rut.slice(-1).toUpperCase();
            let suma = 0;
            let multiplo = 2;
            for (let i = cuerpo.length - 1; i >= 0; i--) {
                suma += multiplo * parseInt(cuerpo.charAt(i));
                multiplo = multiplo < 7 ? multiplo + 1 : 2;
            }
            let dvEsperado = 11 - (suma % 11);
            dvEsperado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
            return dv === dvEsperado;
        }

        function aplicarFormatoRUT(input) {
            input.addEventListener('input', function (e) {
                let cursorPos = this.selectionStart;
                let valorAnterior = this.value;
                this.value = formatearRUT(this.value);
                if (this.value.length > valorAnterior.length) {
                    cursorPos++;
                }
                this.setSelectionRange(cursorPos, cursorPos);
            });

            input.addEventListener('blur', function () {
                if (this.value && !validarRUT(this.value)) {
                    this.classList.add('is-invalid');
                    if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
                        let errorMsg = document.createElement('div');
                        errorMsg.className = 'invalid-feedback';
                        errorMsg.textContent = 'RUT inv√°lido';
                        this.parentNode.appendChild(errorMsg);
                    }
                } else {
                    this.classList.remove('is-invalid');
                    if (this.nextElementSibling && this.nextElementSibling.classList.contains('invalid-feedback')) {
                        this.nextElementSibling.remove();
                    }
                }
            });

            input.addEventListener('focus', function () {
                this.classList.remove('is-invalid');
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const rutInput = document.getElementById('rut');
            if (rutInput) aplicarFormatoRUT(rutInput);
            const editRutInput = document.getElementById('edit-rut');
            if (editRutInput) aplicarFormatoRUT(editRutInput);
            const filtroRutInputs = document.querySelectorAll('input[name="rut"]');
            filtroRutInputs.forEach(input => aplicarFormatoRUT(input));
        });

        // Validaci√≥n RUT en el submit de formularios
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function (e) {
                const rutInputs = this.querySelectorAll('input[name="rut"]');
                let rutValido = true;
                rutInputs.forEach(input => {
                    if (input.value && !validarRUT(input.value)) {
                        e.preventDefault();
                        input.classList.add('is-invalid');
                        if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                            let errorMsg = document.createElement('div');
                            errorMsg.className = 'invalid-feedback';
                            errorMsg.textContent = 'RUT inv√°lido';
                            input.parentNode.appendChild(errorMsg);
                        }
                        rutValido = false;
                    }
                });
                if (!rutValido) {
                    alert('Por favor, corrija los RUTs inv√°lidos antes de continuar.');
                }
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <footer class="mt-4">
        {% include "includes/footer.html" %}
    </footer>
</body>

</html>