{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administracions</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome para los 铆conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">


</head>

<body>
    {% include "includes/logout.html" %}

    <div class="container">
        <br>
        <h1 class="text-center mb-4" style="padding-left: 30%;">拆拣金 叼叼拆葛</h1>

        
        <form method="get" action="{% url 'listadoFallecidos' %}" class="mb-4">
            <div class="row g-3">
                <!-- Filtros de texto -->
                <div class="col-md-3">
                    <input type="text" name="rut" class="form-control campo-input" placeholder="Rut" value="{{ request.GET.rut|default_if_none:'' }}">

                </div>
                <div class="col-md-3">
                    <input type="text" name="nombre" class="form-control campo-input" placeholder="Nombre" value="{{ request.GET.nombre|default_if_none:'' }}">

                </div>
                <div class="col-md-3">
                    <input type="text" name="apellido_p" class="form-control campo-input" value="{{ request.GET.apellido_p|default_if_none:'' }}" placeholder="Apellido Paterno">
                </div>
                <div class="col-md-3">
                    <input type="text" name="apellido_m" class="form-control campo-input" value="{{ request.GET.apellido_m|default_if_none:'' }}" placeholder="Apellido Materno">
                </div>
        
                <!-- Filtros de fecha -->
                <div class="col-md-3">
                    <input type="date" name="fecha_inicio" class="form-control campo-input" value="{{ request.GET.fecha_inicio|default_if_none:'' }}">
                </div>
                <div class="col-md-3">
                    <input type="date" name="fecha_fin" class="form-control campo-input" value="{{ request.GET.fecha_fin|default_if_none:'' }}">
                </div>
        
                <!-- Filtro de Ubicaci贸n -->
                <div class="col-md-3">
                    <select name="ubicacion" class="form-control campo-input" >
                        {% for choice, label in filter_form.ubicacion.field.choices %}
                            <option value="{{ choice }}" {% if filter_form.ubicacion.value == choice %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
        
                <!-- Bot贸n de filtro -->
                <div class="col-md-3 d-grid">
                    <div class="btn-group" role="group" style="width: 100%;">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Filtrar</button>
                        <a href="{% url 'listadoFallecidos' %}" class="btn btn-primary" style="padding-top: 10px;"><i class="fas fa-times"></i> Limpiar</a>
                    </div>
                </div>
                
            </div>
        </form>
        
        
        <div class="row">
            <!-- Columna Izquierda: Formulario para agregar fallecido -->
            <div class="col-md-4" style="padding-bottom: 20px;">
                <div class="card form-card">
                    <div class="card-header text-center">
                        <h4>Agregar Fallecido</h4>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                        <div id="message-container" class="mt-3">
                            {% for message in messages %}
                                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <form method="post" action="{% url 'agregarFallecido' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="rut" class="form-label">RUT</label>
                                <input type="text" class="form-control campo-input"  id="rut" name="rut" placeholder="Ingrese Rut">
                            </div>
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" 
                                       class="form-control campo-input" 
                                       id="nombre" 
                                       name="nombre" 
                                       placeholder="Ingrese Nombre" 
                                       pattern="[A-Za-z谩茅铆贸煤帽\s]+" 
                                       title="Solo se permiten letras y espacios." 
                                       oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="mb-3">
                                <label for="apellido_p" class="form-label">Apellido P</label>
                                <input type="text" 
                                       class="form-control campo-input" 
                                       id="apellido_p" 
                                       name="apellido_p" 
                                       placeholder="Ingresar Apellido" 
                                       pattern="[A-Za-z谩茅铆贸煤帽\s]+" 
                                       title="Solo se permiten letras y espacios." 
                                       oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="mb-3">
                                <label for="apellido_m" class="form-label">Apellido M</label>
                                <input type="text" 
                                       class="form-control campo-input" 
                                       id="apellido_m" 
                                       name="apellido_m" 
                                       placeholder="Ingresar Apellido" 
                                       pattern="[A-Za-z谩茅铆贸煤帽\s]+" 
                                       title="Solo se permiten letras y espacios." 
                                       oninput="this.value = this.value.toUpperCase()">
                            </div>
                            
                            
                            <div class="mb-3">
                                <label for="fechafallecimiento" class="form-label">Fecha Fallecimiento</label>
                                <input type="date" class="form-control campo-input"  id="fechafallecimiento" name="fechafallecimiento">
                            </div>
                            <div class="mb-3">
                                <label for="ubicacion" class="form-label">Ubicaci贸n</label>
                                <select class="form-control campo-input"  id="ubicacion" name="ubicacion">
                                    <option value="">Seleccione una ubicaci贸n</option>
                                    <option value="sotano">S贸tano</option>
                                    <option value="bloque_1">Bloque 1</option>
                                    <option value="bloque_2">Bloque 2</option>
                                    <option value="miramar">Miramar</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="maps" class="form-label">Maps</label>
                                <input type="text" class="form-control campo-input"  id="maps" name="maps" placeholder="Ingresar Maps">
                            </div>
                            <div class="d-flex justify-content-around">
                                <button type="submit" class="btn btn-success">Agregar</button>
                                <button type="reset" class="btn btn-danger">Limpiar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Columna Derecha: Tabla de fallecidos -->
            <div class="col-md-8">
                {% if fallecidos %}
                    <div class="table-responsive table-container">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>RUT</th>
                                    <th>Nombre</th>
                                    <th>ApellidoP</th>
                                    <th>ApellidoM</th>
                                    <th>Fecha Fallecimiento</th>
                                    <th>Ubicacion</th>
                                    <th>Maps</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fallecido in fallecidos %}
                                    <tr>
                                        <td>{{ fallecido.rut }}</td>
                                        <td>{{ fallecido.nombre }}</td>
                                        <td>{{ fallecido.apellido_p }}</td>
                                        <td>{{ fallecido.apellido_m }}</td>
                                        <td>{{ fallecido.fechafallecimiento|date:"d-m-Y" }}</td>
                                        <td>{{ fallecido.ubicacion }}</td>
                                        <td>{{ fallecido.maps }}</td>
                                        <td>
                                            <button class="btn btn-success btn-sm custom-btn" data-bs-toggle="modal" data-bs-target="#editModal"
                                                data-id="{{ fallecido.id }}" 
                                                data-rut="{{ fallecido.rut }}" 
                                                data-nombre="{{ fallecido.nombre }}" 
                                                data-apellido_p="{{ fallecido.apellido_p }}" 
                                                data-apellido_m="{{ fallecido.apellido_m }}" 
                                                data-fechafallecimiento="{{ fallecido.fechafallecimiento|date:'Y-m-d' }}"
                                                data-ubicacion="{{ fallecido.ubicacion }}" 
                                                data-maps="{{ fallecido.maps }}">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <a href="{% url 'eliminarFallecido' fallecido.id %}" class="btn btn-danger btn-sm custom-btn">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-primary text-center" role="alert">
                        <strong>No se encuentran resultados en el sistema</strong>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        // Espera 5 segundos y luego oculta el mensaje
        setTimeout(() => {
            const messageContainer = document.getElementById('message-container');
            if (messageContainer) {
                // Desvanece el contenedor
                messageContainer.style.transition = "opacity 1s ease";
                messageContainer.style.opacity = "0";
                
                // Despu茅s de la animaci贸n, quita el contenedor para evitar el espacio vac铆o
                setTimeout(() => {
                    messageContainer.remove();
                }, 1000); // Espera 1 segundo para que termine la transici贸n
            }
        }, 3000); // Cambia el tiempo (5000 ms = 5 segundos) si deseas que dure m谩s o menos
    </script>

    <!-- Modal de Edici贸n -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'actualizarFallecido' id=0 %}" id="editForm">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="edit-id">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit-rut" class="form-label">RUT</label>
                            <input type="text" class="form-control campo-input"  id="edit-rut" name="rut">
                        </div>
                        <div class="mb-3">
                            <label for="edit-nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control campo-input"  id="edit-nombre" name="nombre">
                        </div>
                        <div class="mb-3">
                            <label for="edit-apellido_p" class="form-label">Apellido P</label>
                            <input type="text" class="form-control campo-input"  id="edit-apellido_p" name="apellido_p">
                        </div>
                        <div class="mb-3">
                            <label for="edit-apellido_m" class="form-label">Apellido M</label>
                            <input type="text" class="form-control campo-input"  id="edit-apellido_m" name="apellido_m">
                        </div>
                        <div class="mb-3">
                            <label for="edit-fechafallecimiento" class="form-label">Fecha Fallecimiento</label>
                            <input type="date" class="form-control campo-input"  id="edit-fechafallecimiento" name="fechafallecimiento">
                        </div>
                        <div class="mb-3">
                            <label for="edit-ubicacion" class="form-label">Ubicaci贸n</label>
                            <select class="form-control campo-input"  id="edit-ubicacion" name="ubicacion">
                                <option value="">Seleccione una ubicaci贸n</option>
                                <option value="sotano">S贸tano</option>
                                <option value="bloque_1">Bloque 1</option>
                                <option value="bloque_2">Bloque 2</option>
                                <option value="miramar">Miramar</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-maps" class="form-label">Maps</label>
                            <input type="text" class="form-control campo-input"  id="edit-maps" name="maps">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script para llenar el modal con los datos del fallecido -->
    <script>
        const editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const fallecidoId = button.getAttribute('data-id');

            document.getElementById('edit-id').value = fallecidoId;
            document.getElementById('editForm').action = `{% url 'actualizarFallecido' 0 %}`.replace('0', fallecidoId);

            document.getElementById('edit-rut').value = button.getAttribute('data-rut');
            document.getElementById('edit-nombre').value = button.getAttribute('data-nombre');
            document.getElementById('edit-apellido_p').value = button.getAttribute('data-apellido_p');
            document.getElementById('edit-apellido_m').value = button.getAttribute('data-apellido_m');
            
            const fechafallecimiento = button.getAttribute('data-fechafallecimiento');
            document.getElementById('edit-fechafallecimiento').value = fechafallecimiento || '';
            
            document.getElementById('edit-ubicacion').value = button.getAttribute('data-ubicacion');
            document.getElementById('edit-maps').value = button.getAttribute('data-maps');
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
<footer>    
    {% include "includes/footer.html" %}
</footer>
</html>
